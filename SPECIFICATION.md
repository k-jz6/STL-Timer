# STL-Timer
GitHubのリポジトリ（`README.md` または `SPECIFICATION.md`）としてそのまま保存できる形式で、仕様書を作成しました。

これまでの修正経緯（セキュリティ対策やUI調整）を「なぜそうしたか」という理由と共に記述しています。これを保存しておけば、半年後に見返しても「ああ、ここはXSS対策でこう書いているんだった」と思い出せるはずです。

---

# Stealth Work Timer (STL-Timer) アプリケーション仕様書

## 1. 概要

**Stealth Work Timer** は、ブラウザ上で動作する作業時間計測アプリケーションです。
サーバーサイドを持たず、すべてのデータを利用者のブラウザ内（IndexedDB/LocalStorage）に保存する「ローカル完結型」の設計により、プライバシーと手軽さを重視しています。
また、Picture-in-Picture (PiP) APIを利用することで、他の作業ウィンドウの最前面に小さなタイマーウィジェットを表示し続けることが可能です。

## 2. システム構成・技術スタック

### 2.1 技術スタック

* **Frontend:** HTML5, CSS3, Vanilla JavaScript (フレームワーク不使用)
* **Storage:**
* **IndexedDB:** 作業ログ、タスク履歴の保存
* **LocalStorage:** アプリ設定（カテゴリリスト、表示設定など）


* **API:** Document Picture-in-Picture API (PiP機能)
* **Deployment:** Static Web Hosting (GitHub Pages等での公開を想定)

### 2.2 ファイル構成

* `index.html`: アプリケーションのメイン構造。ダッシュボードとウィジェット（PiP用）を含む。
* `style.css`: 全体のデザイン定義。PiP時のレイアウト調整も含む。
* `app.js`: アプリケーションロジック、DB操作、イベントハンドリング。
* `manifest.json`: PWA (Progressive Web Apps) 対応用の設定ファイル。

---

## 3. セキュリティ仕様（脆弱性対策）

本アプリは外部サーバーと通信しませんが、ブラウザ上で動作するWebアプリとして以下の脆弱性対策を実装しています。**（修正・保守時はこのルールを厳守すること）**

### 3.1 クロスサイトスクリプティング (XSS) 対策 [CWE-79]

* **DOM操作のルール:**
* `innerHTML` の使用を禁止しています。
* 動的なコンテンツ生成には必ず `document.createElement`, `textContent`, `document.createTextNode` を使用します。
* これにより、ユーザー入力に悪意あるスクリプトタグが含まれていても、無害な文字列として扱われます。


* **Content Security Policy (CSP):**
* `<meta>` タグにより、外部スクリプトの読み込みと実行を禁止しています (`script-src 'self'`)。
* インラインスタイル (`style-src 'unsafe-inline'`) はPiP機能の仕様上許可していますが、スクリプト実行には影響しません。



### 3.2 CSVインジェクション (Formula Injection) 対策 [CWE-1236]

* **CSV出力時のサニタイズ:**
* Excel等の表計算ソフトが「数式」として解釈する文字（`=`, `+`, `-`, `@`, Tab, CR）で始まるデータに対し、先頭にシングルクォート `'` を付与します。
* これにより、悪意あるコマンド実行を防ぎ、単なる文字列として表示させます。


* **実装箇所:** `app.js` 内の `sanitizeCSVField` 関数。

### 3.3 入力検証 (Input Validation) [CWE-20]

* **文字数制限 (HTML/Physical):**
* タスク名入力: `maxlength="100"`
* カテゴリ名入力: `maxlength="30"`


* **文字数制限 (JavaScript/Logical):**
* プログラム側でも保存前に `.substring(0, 50)` 等でカット処理を行い、開発者ツール等でHTML制限を突破された場合のDoS攻撃やDB肥大化を防ぎます。



---

## 4. UI/UX仕様・表示制限

画面レイアウトの崩れを防ぐため、以下の表示ルールを適用しています。

### 4.1 入力・選択時の表示制限

データの実体（保存される値）は全文字保持しますが、**見た目（表示）のみ**以下のように省略します。

| 箇所 | 対象 | 表示制限 (ロジック) | 挙動 |
| --- | --- | --- | --- |
| **Timer画面** | 履歴プルダウン | **23文字** + "…" | `app.js`で生成時にカット処理 |
| **Timer画面** | 分類プルダウン | **15文字** + "…" | `app.js`で生成時にカット処理 |
| **Timer画面** | 入力欄 | (CSS依存) | 横スクロールして表示 |

### 4.2 作業履歴テーブル（ダッシュボード）

CSS (`style.css`) により、以下の幅を超えた場合は「…」で省略表示します。

* **分類列 (4列目):** `max-width: 15em` (約15文字分)
* **内容列 (5列目):** `max-width: 23em` (約23文字分)

### 4.3 設定画面

* すべての文字を省略せず、改行して表示します（データ管理用のため）。

---

## 5. データ構造 (IndexedDB)

DB名: `WorkTimerDB` (Version: 3)

### 5.1 Object Store: `logs` (作業ログ)

* `id`: (Auto Increment) - 主キー
* `startTime`: (ISO String) - 開始時間
* `endTime`: (ISO String) - 終了時間
* `duration`: (String) - 経過時間 (HH:MM:SS)
* `category`: (String) - 分類
* `task`: (String) - 内容
* `createdAt`: (ISO String) - レコード作成日時

### 5.2 Object Store: `tasks` (履歴用タスクマスタ)

* `name`: (String) - 主キー (タスク内容そのもの)

---

## 6. 今後の保守・運用時の注意点

### 6.1 機能追加時の注意

* **JSONインポート機能の実装:**
* 現在「JSONバックアップ（出力）」機能はありますが、「読み込み」機能はありません。
* もし実装する場合、読み込んだJSONデータが不正な構造でないか、悪意あるコードが含まれていないかの**バリデーション（検証）処理が必須**です。そのまま `innerHTML` 等に流し込まないでください。


* **ライブラリの追加:**
* 外部ライブラリ（CDN等）を追加する場合は、CSP (`index.html`のmetaタグ) の設定変更が必要です。セキュリティリスクが増えるため、可能な限りVanilla JSでの実装を推奨します。



### 6.2 ブラウザ互換性

* **Picture-in-Picture API:**
* 比較的新しいAPIを使用しています。Chrome, Edge等のChromium系ブラウザで動作します。FirefoxやSafariではPiPウィンドウが開かない（またはフォールバック動作が必要）場合があります。


* **IndexedDB容量:**
* ブラウザのディスク容量制限に依存します。数万件レベルのログが溜まると動作が重くなる可能性があるため、定期的なCSVエクスポートと「削除」をユーザーに推奨する運用としています。



---

*Document Created: 2025-12-31*
